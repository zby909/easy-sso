# SSO è®¤è¯æˆæƒä¸­å¿ƒ

[![Node.js](https://img.shields.io/badge/Node.js-20+-green.svg)](https://nodejs.org/)
[![TypeScript](https://img.shields.io/badge/TypeScript-5.0+-blue.svg)](https://www.typescriptlang.org/)
[![Koa.js](https://img.shields.io/badge/Koa.js-2.15+-lightgrey.svg)](https://koajs.com/)
[![License](https://img.shields.io/badge/License-ISC-yellow.svg)](LICENSE)

ğŸ” ä¸€ä¸ªåŸºäº OAuth 2.0 + PKCE æ ‡å‡†æ„å»ºçš„å•ç‚¹ç™»å½•(SSO)è®¤è¯æˆæƒä¸­å¿ƒï¼Œæä¾›èº«ä»½è®¤è¯å’ŒæˆæƒæœåŠ¡ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### ğŸš€ è®¤è¯æˆæƒ

- **OAuth 2.0 æˆæƒç æµç¨‹** - å®ç°æ ‡å‡† OAuth 2.0 Authorization Code Flow
- **PKCE å®‰å…¨å¢å¼º** - ä½¿ç”¨ PKCE (Proof Key for Code Exchange) é˜²æ­¢æˆæƒç åŠ«æŒ
- **JWT ä»¤ç‰Œç³»ç»Ÿ** - æ”¯æŒ Access Token å’Œ Refresh Token çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **æ— å¯†ç é‚®ç®±è®¤è¯** - åŸºäºé‚®ç®±éªŒè¯ç çš„æ— å¯†ç æ³¨å†Œå’Œç™»å½•ç³»ç»Ÿ

### ğŸ”§ æŠ€æœ¯æ¶æ„

- **é«˜æ€§èƒ½åç«¯** - åŸºäº Koa.js æ„å»ºçš„è½»é‡çº§ Node.js æœåŠ¡
- **ç±»å‹å®‰å…¨** - ä½¿ç”¨ TypeScript å¼€å‘ï¼Œæä¾›ç±»å‹æ£€æŸ¥å’Œä»£ç æç¤º
- **æ•°æ®åº“æŠ½è±¡** - ä½¿ç”¨ Prisma ORMï¼Œæ”¯æŒ MySQLã€PostgreSQLã€SQLite ç­‰æ•°æ®åº“
- **Redis ç¼“å­˜** - åŸºäº Redis çš„ä¼šè¯ç®¡ç†å’Œæ•°æ®ç¼“å­˜
- **æ—¥å¿—ç³»ç»Ÿ** - é›†æˆ Winston æ—¥å¿—ç³»ç»Ÿï¼Œæ”¯æŒæ–‡ä»¶å’Œæ§åˆ¶å°è¾“å‡º

### ğŸ›¡ï¸ å®‰å…¨ä¿éšœ

- **æ— å¯†ç è®¤è¯** - åŸºäºé‚®ç®±éªŒè¯ç çš„æ— å¯†ç ç™»å½•
- **ä¼šè¯å®‰å…¨** - åŸºäº Redis çš„åˆ†å¸ƒå¼ä¼šè¯ç®¡ç†ï¼Œæ”¯æŒä¼šè¯è¿‡æœŸå’Œé”€æ¯
- **é¢‘ç‡é™åˆ¶** - é’ˆå¯¹é‚®ä»¶å‘é€å’Œ IP è¯·æ±‚çš„å¤šå±‚é¢‘ç‡é™åˆ¶ï¼Œé˜²æ­¢æ»¥ç”¨æ”»å‡»
- **CORS ä¿æŠ¤** - è·¨åŸŸèµ„æºå…±äº«é…ç½®ï¼Œé˜²æ­¢æ¶æ„è¯·æ±‚
- **é‡å®šå‘ç™½åå•** - é‡å®šå‘ URI ç™½åå•éªŒè¯æœºåˆ¶
- **ä»¤ç‰ŒéªŒè¯** - JWT ä»¤ç‰Œç­¾åéªŒè¯å’Œè¿‡æœŸæ£€æŸ¥

## ğŸ—ï¸ æŠ€æœ¯æ ˆ

| åˆ†ç±»           | æŠ€æœ¯é€‰å‹   | ç‰ˆæœ¬  | è¯´æ˜                                      |
| -------------- | ---------- | ----- | ----------------------------------------- |
| **è¿è¡Œæ—¶**     | Node.js    | 20+   | JavaScript è¿è¡Œç¯å¢ƒ                       |
| **å¼€å‘è¯­è¨€**   | TypeScript | 5.0+  | ç±»å‹å®‰å…¨çš„ JavaScript è¶…é›†                |
| **Web æ¡†æ¶**   | Koa.js     | 2.15+ | è½»é‡çº§ Node.js Web æ¡†æ¶                   |
| **æ•°æ®åº“ ORM** | Prisma     | 6.8+  | ç°ä»£åŒ–æ•°æ®åº“å·¥å…·åŒ…                        |
| **æ•°æ®åº“**     | MySQL      | 8.0+  | å…³ç³»å‹æ•°æ®åº“ï¼ˆä¹Ÿæ”¯æŒ PostgreSQLã€SQLiteï¼‰ |
| **ç¼“å­˜/ä¼šè¯**  | Redis      | 6.0+  | é«˜æ€§èƒ½é”®å€¼å­˜å‚¨æ•°æ®åº“                      |
| **è®¤è¯æœºåˆ¶**   | JWT        | 9.0+  | JSON Web Token ä»¤ç‰Œç³»ç»Ÿ                   |
| **æ—¥å¿—ç³»ç»Ÿ**   | Winston    | 3.15+ | æ—¥å¿—è®°å½•åº“                                |
| **é‚®ä»¶æœåŠ¡**   | Nodemailer | 7.0+  | Node.js é‚®ä»¶å‘é€åº“                        |

## ğŸ“‹ ç¯å¢ƒè¦æ±‚

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨çš„å¼€å‘ç¯å¢ƒä¸­å®‰è£…äº†ä»¥ä¸‹è½¯ä»¶ï¼š

- [Node.js](https://nodejs.org/) (å»ºè®® v20.x æˆ–æ›´é«˜ç‰ˆæœ¬)
- [pnpm](https://pnpm.io/) (æ¨è) æˆ– npm/yarn
- [Redis](https://redis.io/) (v6.0 æˆ–æ›´é«˜ç‰ˆæœ¬)
- [MySQL](https://www.mysql.com/) (v8.0 æˆ–æ›´é«˜ç‰ˆæœ¬) æˆ–å…¶ä»– Prisma æ”¯æŒçš„æ•°æ®åº“

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å…‹éš†é¡¹ç›®

```bash
git clone https://github.com/zby909/sso-auth.git
cd sso-auth
```

### 2. å®‰è£…ä¾èµ–

```bash
pnpm install
```

### 3. ç¯å¢ƒé…ç½®

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env` æ–‡ä»¶ï¼š

```env
# åº”ç”¨é…ç½®
NODE_ENV=development
PORT=3000

# æ•°æ®åº“è¿æ¥ (MySQL ç¤ºä¾‹)
DATABASE_URL="mysql://username:password@localhost:3306/sso_auth"

# Redis é…ç½®
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# å®‰å…¨å¯†é’¥ (è¯·ä½¿ç”¨å¼ºéšæœºå­—ç¬¦ä¸²)
JWT_SECRET="your_super_secret_jwt_key_here"
REFRESH_SECRET="your_super_secret_refresh_key_here"
SESSION_SECRET="your_super_secret_session_key_here"

# CORS é…ç½®
FRONTEND_URL="http://localhost:8080"

# SMTP é‚®ä»¶é…ç½® (å¯é€‰ï¼Œç”¨äºéªŒè¯ç å‘é€)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password

# é¢‘ç‡é™åˆ¶é…ç½®
RATE_LIMIT_EMAIL_WINDOW_MS=60000
RATE_LIMIT_EMAIL_MAX_REQUESTS=2
RATE_LIMIT_IP_WINDOW_MS=60000
RATE_LIMIT_IP_MAX_REQUESTS=200
```

### 4. æ•°æ®åº“åˆå§‹åŒ–

```bash
# ç”Ÿæˆ Prisma å®¢æˆ·ç«¯
pnpm prisma generate

# æ‰§è¡Œæ•°æ®åº“è¿ç§»
pnpm prisma migrate dev --name init

# (å¯é€‰) æŸ¥çœ‹æ•°æ®åº“
pnpm prisma studio
```

### 5. å¯åŠ¨æœåŠ¡

```bash
# å¼€å‘æ¨¡å¼ (æ”¯æŒçƒ­é‡è½½)
pnpm dev

# ç”Ÿäº§æ¨¡å¼
pnpm build && pnpm start
```

æœåŠ¡å°†åœ¨ `http://localhost:3000` å¯åŠ¨ ğŸ‰

## ğŸ“š OAuth 2.0 + PKCE è®¤è¯æµç¨‹

æœ¬ç³»ç»Ÿå®ç°äº† OAuth 2.0 æˆæƒç æµç¨‹ï¼Œå¹¶ä½¿ç”¨ PKCE å¢å¼ºå®‰å…¨æ€§ï¼š

### ğŸ­ ç³»ç»Ÿè§’è‰²è¯´æ˜

åœ¨å®Œæ•´çš„SSOè®¤è¯ä½“ç³»ä¸­ï¼ŒåŒ…å«ä»¥ä¸‹å…³é”®è§’è‰²ï¼š

| è§’è‰²                   | è¯´æ˜               | èŒè´£                                            |
| ---------------------- | ------------------ | ----------------------------------------------- |
| **ï¸ å®¢æˆ·ç«¯åº”ç”¨å‰ç«¯**   | ä¸šåŠ¡åº”ç”¨çš„å‰ç«¯éƒ¨åˆ† | å‘èµ·è®¤è¯è¯·æ±‚ã€å¤„ç†æˆæƒç ã€å­˜å‚¨ä»¤ç‰Œã€è°ƒç”¨ä¸šåŠ¡API |
| **ğŸŒ SSOå‰ç«¯ç™»å½•ä¸­å¿ƒ** | SSOç³»ç»Ÿçš„ç”¨æˆ·ç•Œé¢  | æä¾›ç™»å½•é¡µé¢ã€æ”¶é›†ç”¨æˆ·å‡­è¯ã€å¤„ç†è®¤è¯äº¤äº’        |
| **ğŸ” SSOåç«¯è®¤è¯ä¸­å¿ƒ** | SSOç³»ç»Ÿçš„æ ¸å¿ƒæœåŠ¡  | éªŒè¯ç”¨æˆ·èº«ä»½ã€é¢å‘æˆæƒç å’Œä»¤ç‰Œã€ç®¡ç†ä¼šè¯        |
| **ğŸ¢ å®¢æˆ·ç«¯åº”ç”¨åç«¯**  | ä¸šåŠ¡åº”ç”¨çš„åç«¯æœåŠ¡ | éªŒè¯SSOä»¤ç‰Œã€æä¾›ä¸šåŠ¡APIã€ç®¡ç†ä¸šåŠ¡æ•°æ®å’Œèµ„æº    |

> ğŸ’¡ **æ³¨æ„**ï¼šæœ¬é¡¹ç›®å®ç°çš„æ˜¯ **SSOåç«¯è®¤è¯ä¸­å¿ƒ** éƒ¨åˆ†ï¼Œä¸ºå…¶ä»–ç³»ç»Ÿæä¾›è®¤è¯æˆæƒæœåŠ¡ã€‚

### ğŸ”„ è®¤è¯æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant ClientFE as ğŸ–¥ï¸ å®¢æˆ·ç«¯åº”ç”¨å‰ç«¯
    participant SSOFE as ğŸŒ SSOå‰ç«¯ç™»å½•ä¸­å¿ƒ
    participant SSOBE as ğŸ” SSOåç«¯è®¤è¯ä¸­å¿ƒ
    participant ClientBE as ğŸ¢ å®¢æˆ·ç«¯åº”ç”¨åç«¯

    Note over ClientFE, SSOBE: 1. å‡†å¤‡ PKCE å‚æ•°
    ClientFE->>ClientFE: ç”Ÿæˆ code_verifier
    ClientFE->>ClientFE: è®¡ç®— code_challenge = SHA256(code_verifier)
    ClientFE->>ClientFE: ç”Ÿæˆ state å‚æ•°

    Note over ClientFE, SSOFE: 2. é‡å®šå‘åˆ°SSOç™»å½•ä¸­å¿ƒ
    ClientFE->>ClientFE: æ£€æµ‹éœ€è¦è®¤è¯
    ClientFE->>SSOFE: é‡å®šå‘åˆ°SSOç™»å½•é¡µé¢<br/>(å¸¦code_challengeå’Œredirect_uri)
    SSOFE->>SSOFE: æ˜¾ç¤ºç™»å½•é¡µé¢

    Note over SSOFE, SSOBE: 3. ç”¨æˆ·è®¤è¯ï¼ˆæ— å¯†ç ï¼‰
    SSOFE->>SSOFE: ç”¨æˆ·è¾“å…¥é‚®ç®±åœ°å€
    SSOFE->>SSOBE: è¯·æ±‚å‘é€éªŒè¯ç 
    SSOBE->>SSOFE: å‘é€é‚®ç®±éªŒè¯ç 
    SSOFE->>SSOFE: ç”¨æˆ·è¾“å…¥éªŒè¯ç 
    SSOFE->>SSOBE: æäº¤éªŒè¯ç ç™»å½•
    SSOBE->>SSOBE: éªŒè¯ç æ ¡éªŒæˆåŠŸ

    Note over SSOBE, ClientFE: 4. æˆæƒç è¿”å›
    SSOBE->>SSOFE: ç™»å½•æˆåŠŸï¼Œç”Ÿæˆæˆæƒç 
    SSOFE->>ClientFE: é‡å®šå‘å›å®¢æˆ·ç«¯(å¸¦æˆæƒç code)
    ClientFE->>ClientFE: æ¥æ”¶æˆæƒç 

    Note over ClientFE, SSOBE: 5. å®¢æˆ·ç«¯è·å–ä»¤ç‰Œ
    ClientFE->>SSOBE: POST /auth/token<br/>{code, code_verifier}
    SSOBE->>SSOBE: éªŒè¯ code å’Œ PKCE
    SSOBE->>ClientFE: è¿”å› access_token + refresh_token
    ClientFE->>ClientFE: å­˜å‚¨ä»¤ç‰Œ

    Note over ClientFE, ClientBE: 6. è®¿é—®ä¸šåŠ¡èµ„æº
    ClientFE->>ClientBE: è¯·æ±‚ä¸šåŠ¡æ¥å£<br/>Authorization: Bearer access_token
    ClientBE->>ClientBE: éªŒè¯JWTä»¤ç‰Œ
    ClientBE->>ClientFE: è¿”å›ä¸šåŠ¡å“åº”

    Note over ClientFE, SSOBE: 7. ä»¤ç‰Œåˆ·æ–°ï¼ˆå¯é€‰ï¼‰
    ClientFE->>SSOBE: POST /auth/refresh<br/>{refresh_token, access_token}
    SSOBE->>ClientFE: è¿”å›æ–°çš„ token å¯¹
```

### ğŸ“ è¯¦ç»†æ­¥éª¤è¯´æ˜

#### ç¬¬ 1 æ­¥ï¼šå®¢æˆ·ç«¯å‰ç«¯å‡†å¤‡ PKCE å‚æ•°

å®¢æˆ·ç«¯åº”ç”¨å‰ç«¯åœ¨å‘èµ·æˆæƒè¯·æ±‚å‰ï¼Œéœ€è¦ç”Ÿæˆ PKCE ç›¸å…³å‚æ•°ï¼š

```javascript
// ç”Ÿæˆ code_verifier (43-128 å­—ç¬¦çš„éšæœºå­—ç¬¦ä¸²)
const codeVerifier = crypto.randomBytes(32).toString('base64url');

// ç”Ÿæˆ code_challenge
const codeChallenge = crypto.createHash('sha256').update(codeVerifier).digest('base64url');

// ç”Ÿæˆ state å‚æ•°é˜²æ­¢ CSRF æ”»å‡»
const state = 'state_' + Date.now();
```

#### ç¬¬ 2 æ­¥ï¼šé‡å®šå‘åˆ°SSOç™»å½•ä¸­å¿ƒ

å½“å®¢æˆ·ç«¯å‰ç«¯æ£€æµ‹åˆ°éœ€è¦è®¤è¯æ—¶ï¼š

```javascript
// å®¢æˆ·ç«¯å‰ç«¯é‡å®šå‘åˆ°SSOç™»å½•ä¸­å¿ƒ
const authUrl =
  `https://sso.example.com/login?` +
  `redirect_uri=${encodeURIComponent(clientRedirectUri)}&` +
  `state=${state}&` +
  `code_challenge=${codeChallenge}&` +
  `code_challenge_method=S256`;

window.location.href = authUrl;
```

#### ç¬¬ 3 æ­¥ï¼šSSOå‰ç«¯å¤„ç†ç”¨æˆ·è®¤è¯

SSOå‰ç«¯ç™»å½•ä¸­å¿ƒå¤„ç†ç”¨æˆ·è®¤è¯ï¼ˆæ— å¯†ç ç™»å½•ï¼‰ï¼š

```bash
# SSOå‰ç«¯è¯·æ±‚å‘é€éªŒè¯ç 
POST /auth/verification/send
{
  "email": "user@example.com",
  "purpose": "login"
}

# SSOå‰ç«¯æäº¤éªŒè¯ç ç™»å½•
POST /auth/login
{
  "email": "user@example.com",
  "code": "123456"
}
```

#### ç¬¬ 4 æ­¥ï¼šSSOè¿”å›æˆæƒç 

ç”¨æˆ·ç™»å½•æˆåŠŸåï¼ŒSSOåç«¯ç”Ÿæˆæˆæƒç å¹¶é€šè¿‡å‰ç«¯é‡å®šå‘è¿”å›ï¼š

```bash
# SSOåç«¯æˆæƒæ¥å£
GET /auth/authorize?redirect_uri=http://localhost:8080&state=state_123&code_challenge=xyz&code_challenge_method=S256
```

**SSOå‰ç«¯é‡å®šå‘å“åº”ï¼š**

```
HTTP/1.1 302 Found
Location: http://localhost:8080?code=auth_code_abc123&state=state_123
```

#### ç¬¬ 5 æ­¥ï¼šå®¢æˆ·ç«¯å‰ç«¯äº¤æ¢è®¿é—®ä»¤ç‰Œ

å®¢æˆ·ç«¯å‰ç«¯æ¥æ”¶æˆæƒç åï¼Œç›´æ¥ä¸SSOåç«¯äº¤æ¢ä»¤ç‰Œï¼š

```bash
POST /auth/token
{
  "code": "auth_code_abc123",
  "code_verifier": "original_code_verifier"
}
```

**å“åº”ç¤ºä¾‹ï¼š**

```json
{
  "code": 200,
  "msg": "ä»¤ç‰Œè·å–æˆåŠŸ",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIs...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIs...",
    "token_type": "Bearer",
    "expires_in": 900
  }
}
```

#### ç¬¬ 6 æ­¥ï¼šè®¿é—®å®¢æˆ·ç«¯ä¸šåŠ¡èµ„æº

å®¢æˆ·ç«¯å‰ç«¯æºå¸¦è®¿é—®ä»¤ç‰Œè¯·æ±‚è‡ªå·±çš„åç«¯æœåŠ¡ï¼š

```bash
# å®¢æˆ·ç«¯å‰ç«¯è¯·æ±‚è‡ªå·±çš„åç«¯API
GET /api/user/profile
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
```

å®¢æˆ·ç«¯åç«¯éªŒè¯ä»¤ç‰Œå¹¶å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼š

```javascript
// å®¢æˆ·ç«¯åç«¯éªŒè¯JWTä»¤ç‰Œï¼ˆæœ¬åœ°éªŒè¯ï¼‰
const jwt = require('jsonwebtoken');
try {
  const decoded = jwt.verify(token, SSO_PUBLIC_KEY);
  // ä»¤ç‰Œæœ‰æ•ˆï¼Œç»§ç»­å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œè¿”å›ä¸šåŠ¡æ•°æ®
  const userProfile = await getUserProfile(decoded.id);
  res.json(userProfile);
} catch (error) {
  // ä»¤ç‰Œæ— æ•ˆï¼Œè¿”å›401
  res.status(401).json({ error: 'Invalid token' });
}
```

#### ç¬¬ 7 æ­¥ï¼šä»¤ç‰Œåˆ·æ–°

å½“è®¿é—®ä»¤ç‰Œè¿‡æœŸæ—¶ï¼Œå®¢æˆ·ç«¯å‰ç«¯ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œè·å–æ–°çš„ä»¤ç‰Œå¯¹ï¼š

```bash
POST /auth/refresh
{
  "refresh_token": "eyJhbGciOiJIUzI1NiIs...",
  "access_token": "eyJhbGciOiJIUzI1NiIs..."
}
```

## ğŸ“– API æ–‡æ¡£

### ğŸ” è®¤è¯ç›¸å…³æ¥å£

| æ¥å£                      | æ–¹æ³• | æè¿°               | è®¤è¯è¦æ±‚ |
| ------------------------- | ---- | ------------------ | -------- |
| `/auth/verification/send` | POST | å‘é€é‚®ç®±éªŒè¯ç      | æ—        |
| `/auth/register`          | POST | ç”¨æˆ·æ³¨å†Œï¼ˆæ— å¯†ç ï¼‰ | æ—        |
| `/auth/login`             | POST | ç”¨æˆ·ç™»å½•ï¼ˆæ— å¯†ç ï¼‰ | æ—        |
| `/auth/logout/center`     | POST | æ³¨é”€ç™»å½•ä¸­å¿ƒ       | Session  |

### ğŸ« OAuth 2.0 æ¥å£

| æ¥å£                 | æ–¹æ³• | æè¿°         | è®¤è¯è¦æ±‚ |
| -------------------- | ---- | ------------ | -------- |
| `/auth/authorize`    | GET  | è·å–æˆæƒç    | Session  |
| `/auth/token`        | POST | è·å–è®¿é—®ä»¤ç‰Œ | æ—        |
| `/auth/refresh`      | POST | åˆ·æ–°è®¿é—®ä»¤ç‰Œ | æ—        |
| `/auth/logout/token` | POST | æ³¨é”€ä»¤ç‰Œ     | æ—        |

### é”™è¯¯å“åº”è¯´æ˜

#### é¢‘ç‡é™åˆ¶é”™è¯¯ (429)

å½“è§¦å‘é¢‘ç‡é™åˆ¶æ—¶ï¼ŒæœåŠ¡å™¨è¿”å›ï¼š

```json
{
  "code": 429,
  "msg": "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•",
  "data": null
}
```

#### å¸¸è§é”™è¯¯ç 

- `400` - è¯·æ±‚å‚æ•°é”™è¯¯
- `401` - è®¤è¯å¤±è´¥
- `404` - èµ„æºä¸å­˜åœ¨
- `429` - è¯·æ±‚é¢‘ç‡é™åˆ¶
- `500` - æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

> ğŸ’¡ **å®Œæ•´ API æ–‡æ¡£**ï¼šæŸ¥çœ‹ [`api-docs`](./api-docs/) ç›®å½•è·å– OpenAPI æ ¼å¼çš„è¯¦ç»†æ–‡æ¡£ï¼Œå¯ç›´æ¥å¯¼å…¥ Apifoxã€Postman ç­‰å·¥å…·ã€‚

## ğŸ§ª æµ‹è¯•

é¡¹ç›®æä¾›äº†æµ‹è¯•è„šæœ¬æ¥éªŒè¯ OAuth 2.0 + PKCE æµç¨‹ï¼š

```bash
# è¿è¡Œ SSO æµ‹è¯•æµç¨‹
node test/sso-complete-test.mjs
```

æµ‹è¯•æµç¨‹æ¨¡æ‹Ÿå®Œæ•´çš„SSOè®¤è¯è¿‡ç¨‹ï¼š

1. âœ… å‘é€æ³¨å†ŒéªŒè¯ç ï¼ˆSSOåç«¯ï¼‰
2. âœ… ç”¨æˆ·æ³¨å†Œï¼ˆSSOåç«¯ï¼Œæ— å¯†ç ï¼‰
3. âœ… å‘é€ç™»å½•éªŒè¯ç ï¼ˆSSOåç«¯ï¼‰
4. âœ… ç”¨æˆ·ç™»å½•ï¼ˆSSOåç«¯ï¼Œæ— å¯†ç ï¼‰
5. âœ… OAuth æˆæƒè·å– codeï¼ˆæ¨¡æ‹ŸSSOå‰ç«¯+åç«¯äº¤äº’ï¼‰
6. âœ… ä½¿ç”¨ code è·å– tokenï¼ˆå®¢æˆ·ç«¯å‰ç«¯ä¸SSOåç«¯ï¼‰
7. âœ… åˆ·æ–° access_tokenï¼ˆå®¢æˆ·ç«¯å‰ç«¯ä¸SSOåç«¯ï¼‰
8. âœ… æ³¨é”€ tokenï¼ˆå®¢æˆ·ç«¯å‰ç«¯ä¸SSOåç«¯ï¼‰
9. âœ… æ³¨é”€ç™»å½•ä¸­å¿ƒï¼ˆSSOå‰ç«¯ä¸åç«¯ï¼‰

> ğŸ“ **è¯´æ˜**ï¼šæµ‹è¯•è„šæœ¬ä¸»è¦éªŒè¯SSOåç«¯è®¤è¯ä¸­å¿ƒçš„åŠŸèƒ½ï¼Œæ¨¡æ‹Ÿäº†å®¢æˆ·ç«¯å‰ç«¯çš„è¯·æ±‚è¡Œä¸ºã€‚

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ app.ts              # Koa åº”ç”¨é…ç½®
â”œâ”€â”€ server.ts           # æœåŠ¡å™¨å¯åŠ¨å…¥å£
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ env.ts          # ç¯å¢ƒå˜é‡åŠ è½½
â”‚   â””â”€â”€ whitelist.ts    # é‡å®šå‘ URI ç™½åå•
â”œâ”€â”€ controllers/        # æ§åˆ¶å™¨å±‚
â”‚   â””â”€â”€ authController.ts
â”œâ”€â”€ middlewares/        # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ authMiddleware.ts
â”‚   â””â”€â”€ errorHandler.ts
â”œâ”€â”€ models/            # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ interfaces.ts  # TypeScript æ¥å£å®šä¹‰
â”‚   â””â”€â”€ stores.ts      # Redis æ•°æ®å­˜å‚¨
â”œâ”€â”€ routes/            # è·¯ç”±å®šä¹‰
â”‚   â”œâ”€â”€ authRoutes.ts
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ services/          # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â””â”€â”€ authService.ts
â””â”€â”€ utils/             # å·¥å…·å‡½æ•°
    â”œâ”€â”€ emailService.ts # é‚®ä»¶æœåŠ¡
    â”œâ”€â”€ logger.ts      # æ—¥å¿—å·¥å…·
    â”œâ”€â”€ redis.ts       # Redis å®¢æˆ·ç«¯
    â””â”€â”€ responseUtil.ts # å“åº”æ ¼å¼åŒ–
```

### å¼€å‘è„šæœ¬

```bash
# å¼€å‘æ¨¡å¼ (çƒ­é‡è½½)
pnpm dev

# ç±»å‹æ£€æŸ¥
pnpm typecheck

# ä»£ç æ ¼å¼åŒ–
pnpm format

# ä»£ç æ£€æŸ¥
pnpm lint

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
pnpm build

# å¯åŠ¨ç”Ÿäº§æœåŠ¡
pnpm start
```

### æ•°æ®åº“æ“ä½œ

```bash
# æŸ¥çœ‹æ•°æ®åº“çŠ¶æ€
pnpm prisma migrate status

# é‡ç½®æ•°æ®åº“ (è°¨æ…ä½¿ç”¨)
pnpm prisma migrate reset

# æ‰“å¼€æ•°æ®åº“ç®¡ç†ç•Œé¢
pnpm prisma studio
```

## ğŸš€ éƒ¨ç½²æŒ‡å—

### Docker éƒ¨ç½² (æ¨è)

1. **åˆ›å»º Docker Compose æ–‡ä»¶**

```yaml
version: '3.8'
services:
  sso-auth:
    build: .
    ports:
      - '3000:3000'
    environment:
      - NODE_ENV=production
      - DATABASE_URL=mysql://user:password@mysql:3306/sso_auth
      - REDIS_HOST=redis
    depends_on:
      - mysql
      - redis

  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: sso_auth
    volumes:
      - mysql_data:/var/lib/mysql

  redis:
    image: redis:6-alpine
    volumes:
      - redis_data:/data

volumes:
  mysql_data:
  redis_data:
```

2. **å¯åŠ¨æœåŠ¡**

```bash
docker-compose up -d
```

### ä¼ ç»Ÿéƒ¨ç½²

1. **æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡**

   ```bash
   # å®‰è£… Node.js 20+
   curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
   sudo apt-get install -y nodejs

   # å®‰è£… PM2 (è¿›ç¨‹ç®¡ç†å™¨)
   npm install -g pm2
   ```

2. **éƒ¨ç½²åº”ç”¨**

   ```bash
   # å…‹éš†ä»£ç 
   git clone https://github.com/zby909/sso-auth.git
   cd sso-auth

   # å®‰è£…ä¾èµ–
   pnpm install --frozen-lockfile

   # æ„å»ºåº”ç”¨
   pnpm build

   # æ•°æ®åº“è¿ç§»
   pnpm prisma migrate deploy

   # å¯åŠ¨æœåŠ¡
   pm2 start ecosystem.config.js
   ```

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡è¯¦ç»†è¯´æ˜

| å˜é‡å           | ç±»å‹   | é»˜è®¤å€¼      | è¯´æ˜                              |
| ---------------- | ------ | ----------- | --------------------------------- |
| `NODE_ENV`       | string | development | è¿è¡Œç¯å¢ƒ (development/production) |
| `PORT`           | number | 3000        | æœåŠ¡ç«¯å£å·                        |
| `DATABASE_URL`   | string | -           | æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²                  |
| `REDIS_HOST`     | string | 127.0.0.1   | Redis ä¸»æœºåœ°å€                    |
| `REDIS_PORT`     | number | 6379        | Redis ç«¯å£                        |
| `REDIS_PASSWORD` | string | -           | Redis å¯†ç  (å¯é€‰)                 |
| `JWT_SECRET`     | string | -           | JWT ç­¾åå¯†é’¥                      |
| `REFRESH_SECRET` | string | -           | Refresh Token ç­¾åå¯†é’¥            |
| `SESSION_SECRET` | string | -           | Session ç­¾åå¯†é’¥                  |
| `FRONTEND_URL`   | string | -           | å‰ç«¯åº”ç”¨ URL (CORS)               |
| `SMTP_HOST`      | string | -           | SMTP æœåŠ¡å™¨åœ°å€                   |
| `SMTP_USER`      | string | -           | SMTP ç”¨æˆ·å                       |
| `SMTP_PASS`      | string | -           | SMTP å¯†ç /åº”ç”¨å¯†ç                 |

### é¢‘ç‡é™åˆ¶é…ç½®è¯´æ˜

ä¸ºé˜²æ­¢æ¶æ„æ”»å‡»å’Œèµ„æºæ»¥ç”¨ï¼Œç³»ç»Ÿå®ç°äº†ä¸¤å±‚é¢‘ç‡é™åˆ¶ï¼š

#### é‚®ç®±éªŒè¯ç é¢‘ç‡é™åˆ¶

- **ç›®çš„**ï¼šé˜²æ­¢æ¶æ„å‘é€å¤§é‡éªŒè¯ç é‚®ä»¶
- **é…ç½®é¡¹**ï¼š
  - `RATE_LIMIT_EMAIL_WINDOW_MS`ï¼šæ—¶é—´çª—å£ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤60ç§’
  - `RATE_LIMIT_EMAIL_MAX_REQUESTS`ï¼šçª—å£å†…æœ€å¤§è¯·æ±‚æ¬¡æ•°ï¼Œé»˜è®¤2æ¬¡
- **è§„åˆ™**ï¼šåŒä¸€é‚®ç®±åœ¨60ç§’å†…æœ€å¤šåªèƒ½è¯·æ±‚2æ¬¡éªŒè¯ç 

#### IP å…¨å±€é¢‘ç‡é™åˆ¶

- **ç›®çš„**ï¼šé˜²æ­¢å•ä¸ªIPçš„æ¶æ„è¯·æ±‚æ”»å‡»
- **é…ç½®é¡¹**ï¼š
  - `RATE_LIMIT_IP_WINDOW_MS`ï¼šæ—¶é—´çª—å£ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤60ç§’
  - `RATE_LIMIT_IP_MAX_REQUESTS`ï¼šçª—å£å†…æœ€å¤§è¯·æ±‚æ¬¡æ•°ï¼Œé»˜è®¤200æ¬¡
- **è§„åˆ™**ï¼šå•ä¸ªIPåœ¨60ç§’å†…æœ€å¤šå‘èµ·200æ¬¡è¯·æ±‚

> âš ï¸ **æ³¨æ„**ï¼šè¶…è¿‡é¢‘ç‡é™åˆ¶æ—¶ï¼ŒæœåŠ¡å™¨å°†è¿”å›429çŠ¶æ€ç ï¼Œå®¢æˆ·ç«¯åº”å®ç°é€‚å½“çš„é‡è¯•æœºåˆ¶ã€‚

### å®‰å…¨é…ç½®å»ºè®®

1. **ç”Ÿæˆå¼ºå¯†é’¥**

   ```bash
   # ç”Ÿæˆ 32 å­—èŠ‚éšæœºå¯†é’¥
   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
   ```

2. **æ•°æ®åº“å®‰å…¨**

   - ä½¿ç”¨ä¸“ç”¨æ•°æ®åº“ç”¨æˆ·ï¼Œä»…æˆäºˆå¿…è¦æƒé™
   - å¯ç”¨ SSL è¿æ¥ (ç”Ÿäº§ç¯å¢ƒ)
   - å®šæœŸå¤‡ä»½æ•°æ®åº“

3. **Redis å®‰å…¨**
   - è®¾ç½®å¼ºå¯†ç 
   - ç¦ç”¨å±é™©å‘½ä»¤ (FLUSHDB, FLUSHALL)
   - é…ç½®é˜²ç«å¢™è§„åˆ™

## ğŸ” ç›‘æ§ä¸è¿ç»´

### å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl http://localhost:3000/health

# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f logs/combined.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f logs/error.log
```

### æ€§èƒ½ç›‘æ§

```bash
# PM2 ç›‘æ§
pm2 monit

# æŸ¥çœ‹åº”ç”¨çŠ¶æ€
pm2 status

# é‡å¯åº”ç”¨
pm2 restart sso-auth
```

## ğŸ›¡ï¸ å®‰å…¨æœ€ä½³å®è·µ

### 1. HTTPS é…ç½®

- ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
- é…ç½® HSTS å¤´
- ä½¿ç”¨æœ‰æ•ˆçš„ SSL è¯ä¹¦

### 2. å®‰å…¨å¤´é…ç½®

```javascript
app.use(
  helmet({
    contentSecurityPolicy: {
      directives: {
        defaultSrc: ["'self'"],
        // ... å…¶ä»– CSP é…ç½®
      },
    },
  }),
);
```

### 3. é™æµé…ç½®

```javascript
app.use(
  rateLimit({
    windowMs: 15 * 60 * 1000, // 15 åˆ†é’Ÿ
    max: 100, // é™åˆ¶æ¯ä¸ª IP 100 æ¬¡è¯·æ±‚
  }),
);
```

### 4. æ—¥å¿—å®¡è®¡

- è®°å½•æ‰€æœ‰è®¤è¯ç›¸å…³æ“ä½œ
- ç›‘æ§å¼‚å¸¸ç™»å½•è¡Œä¸º
- å®šæœŸå®¡æŸ¥è®¿é—®æ—¥å¿—

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿å¤§å®¶è´¡çŒ®ä»£ç å’Œå»ºè®®ï¼

### å¼€å‘æµç¨‹

1. **Fork é¡¹ç›®**
2. **åˆ›å»ºåŠŸèƒ½åˆ†æ”¯**
   ```bash
   git checkout -b feature/new-feature
   ```
3. **æäº¤æ›´æ”¹**
   ```bash
   git commit -m "feat: add new feature"
   ```
4. **æ¨é€åˆ†æ”¯**
   ```bash
   git push origin feature/new-feature
   ```
5. **åˆ›å»º Pull Request**

### ä»£ç è§„èŒƒ

- éµå¾ª ESLint å’Œ Prettier é…ç½®
- ç¼–å†™å•å…ƒæµ‹è¯•
- æ·»åŠ é€‚å½“çš„ç±»å‹æ³¨è§£
- æ›´æ–°ç›¸å…³æ–‡æ¡£

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäº [ISC License](LICENSE) å¼€æºåè®®å‘å¸ƒã€‚

## ğŸ™ è‡´è°¢

æ„Ÿè°¢ä»¥ä¸‹å¼€æºé¡¹ç›®ï¼š

- [Koa.js](https://koajs.com/) - è½»é‡çº§ Node.js Web æ¡†æ¶
- [Prisma](https://www.prisma.io/) - ç°ä»£åŒ–æ•°æ®åº“å·¥å…·åŒ…
- [Redis](https://redis.io/) - é«˜æ€§èƒ½é”®å€¼å­˜å‚¨
- [Winston](https://github.com/winstonjs/winston) - æ—¥å¿—åº“

## ğŸ“ æ”¯æŒä¸è”ç³»

- **Issues**: [GitHub Issues](https://github.com/zby909/sso-auth/issues)
- **Discussions**: [GitHub Discussions](https://github.com/zby909/sso-auth/discussions)
- **é‚®ç®±**: your-email@example.com

---

<div align="center">

**â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç»™ä¸ª Starï¼â­**

Made with â¤ï¸ by [zby909](https://github.com/zby909)

</div>
